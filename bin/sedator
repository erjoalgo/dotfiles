#!/bin/bash

set -euo pipefail

echo "sedator invoked as: ${0} ${@}"

while getopts "i:l:b:c:" OPT; do
    case ${OPT} in
    i)
        IDLE_SECS=${OPTARG}
        ;;
    l)
        LID_STATE=${OPTARG}
        ;;
    b)
        BATTERY=${OPTARG}
        ;;
    c)
        CHARGING=${OPTARG}
        ;;
    h)
        less $0
        exit 0
        ;;
    esac
done
shift $((OPTIND -1))

MINS=$((${IDLE_SECS} / 60))
echo "idle time: ${MINS}m"

if test -n "${BATTERY:-}"; then
    # battery detected. considering sedation
    if test ${MINS} -gt 60; then
        echo "hibernating"
        sudo systemctl hibernate
    elif test ${MINS} -gt 30; then
        echo "suspending..."
        sudo systemctl suspend
    fi
fi

if test ${MINS} -lt 10; then
    echo "taking no sedating action"
elif command -v light-locker-command; then
    light-locker-command -l
elif command -v xsecurelock; then
    if ! pgrep xsecurelock; then
        export DISPLAY=:0
        xhost +SI:localuser:root
        nohup xsecurelock &
        disown
    fi
elif pgrep X; then
    echo "no desktop locker found!" && exit ${LINENO}
else
    echo "no desktop locker found but no X server"
fi

# Local Variables:
# mode: sh-mode
# End:

;; -*- mode: lisp; -*-
(in-package :stumpwm)

;; sbclrc gives us quickload
(load (merge-pathnames ".sbclrc" (user-homedir-pathname)))

(defun load-stumpwmrc-file (relative-path)
  (let ((source-directory
          (or *load-truename*
              (merge-pathnames #P".stumpwmrc.d/lisp/"
                               (user-homedir-pathname)))))
    (load (merge-pathnames relative-path source-directory))))

(load-stumpwmrc-file "erjoalgo-stumpwmrc.asd")
(ql:quickload :erjoalgo-stumpwmrc)

(defvar *init-errors* nil)

(defmacro safe-init-sexp (&body body)
  "evaluate an expression, handling and recording errors"
  `(handler-case
       (progn ,@body)
     (error (err)
       (push (list ',body err) *init-errors*)
       (message-wrapped "error while loading: ~A~%: '~A'" ',body err))))

(safe-init-sexp (load-stumpwmrc-file "defs-secret.lisp")) ;; file may not exist
(swank-start)
(xinitrc-init)
(load-stumpwmrc-file "top-map-bindings.lisp") ;; TODO remove side-effects. add "init" method
(init-decorations)
(url-launcher-init)
(text-shortcuts-init)
(init-brightness)
(safe-init-sexp (contacts:contacts-load)) ;; contacts file may not exist
(x-service-start 1959)
(def-thread-start *battery-notification-thread*
  (battery-info-check-notify-loop))
(def-thread-start *sms-fanout-reconnect-thread*
  (sms-fanout-client:reconnect-loop *sms-fanout-ws-address*))
;; (sb-thread:terminate-thread *sms-fanout-reconnect-thread*)
(setf *startup-message* nil)
(startup-apps-run)
